# Тесткейсы для функциональности закрытия Drawer меню

## Общая информация

**Компонент:** MapScreen - ModalNavigationDrawer  
**Функциональность:** Закрытие бургер-меню при клике на область справа от меню  
**Дата создания:** 18 января 2026

---

## Тесткейсы

### TC-001: Открытие меню через кнопку бургера
**Приоритет:** Высокий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты (MapScreen)
- Меню закрыто

**Шаги:**
1. Найти и нажать на кнопку бургера (иконка меню) в TopAppBar

**Ожидаемый результат:**
- Меню открывается слева
- Ширина меню составляет 280.dp
- Область справа от меню остается видимой (карта видна)

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-002: Закрытие меню при клике справа от меню
**Приоритет:** Высокий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть на область справа от меню (начиная с 280.dp от левого края)

**Ожидаемый результат:**
- Меню закрывается
- В логах появляется сообщение: "DEBUG: Overlay tap detected via pointerInput"
- В логах появляется сообщение: "DEBUG: Closing drawer"
- В логах появляется сообщение: "DEBUG: Drawer close() called successfully"

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-003: Закрытие меню при клике в разных областях справа от меню
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть в верхней части области справа от меню
3. Открыть меню снова
4. Кликнуть в центральной части области справа от меню
5. Открыть меню снова
6. Кликнуть в нижней части области справа от меню

**Ожидаемый результат:**
- Меню закрывается при каждом клике в любой части области справа от меню
- Кликабельная область начинается с 280.dp от левого края и занимает всю оставшуюся ширину экрана

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-004: Клик на область меню не закрывает меню
**Приоритет:** Высокий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть на область меню (слева от 280.dp)

**Ожидаемый результат:**
- Меню остается открытым
- Можно взаимодействовать с элементами меню (кликать на пункты меню)
- В логах НЕ появляются сообщения о закрытии drawer

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-005: Закрытие меню через пункты меню
**Приоритет:** Высокий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть на пункт меню "Маршруты"
3. Открыть меню снова
4. Кликнуть на пункт меню "Главное меню"
5. Открыть меню снова
6. Кликнуть на пункт меню "Настройки"

**Ожидаемый результат:**
- Меню закрывается при клике на любой пункт меню
- Происходит навигация на соответствующий экран

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-006: Закрытие меню через кнопку бургера когда меню открыто
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Нажать на кнопку бургера снова

**Ожидаемый результат:**
- Меню закрывается
- Кнопка бургера работает как переключатель (toggle)

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-007: Закрытие меню через клик на заголовок TopAppBar
**Приоритет:** Низкий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть на заголовок в TopAppBar

**Ожидаемый результат:**
- Меню закрывается при клике на заголовок

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-008: Проверка прозрачности кликабельного слоя
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Визуально проверить область справа от меню

**Ожидаемый результат:**
- Область справа от меню полностью прозрачна (нет серого фона)
- Карта видна полностью без затемнения
- Нет текста "Кликните здесь для закрытия меню"

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-009: Проверка границы кликабельной области
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть точно на границе между меню и картой (около 280.dp от левого края)
3. Попробовать кликнуть слева от границы (в области меню)
4. Попробовать кликнуть справа от границы (в области карты)

**Ожидаемый результат:**
- Клик точно на границе (280.dp) закрывает меню
- Клик слева от границы (в меню) не закрывает меню
- Клик справа от границы (на карте) закрывает меню

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-010: Проверка работы карты когда меню открыто
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Попытаться переместить карту жестами (свайп, пинч)
3. Попытаться кликнуть на маркеры на карте

**Ожидаемый результат:**
- Карта не перемещается жестами когда меню открыто
- Клик на маркеры не работает когда меню открыто (вместо этого меню закрывается)
- После закрытия меню карта снова становится интерактивной

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-011: Проверка логов при закрытии меню
**Приоритет:** Низкий  
**Предусловия:**
- Приложение запущено
- Поги включены логи (Logcat)
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Кликнуть на область справа от меню
3. Проверить логи в Logcat

**Ожидаемый результат:**
- В логах появляется: "DEBUG: Overlay tap detected via pointerInput at offset: ..."
- В логах появляется: "DEBUG: Closing drawer, current state: Open"
- В логах появляется: "DEBUG: Drawer close() called successfully, new state: Closed"
- Нет ошибок (ERROR) в логах

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-012: Проверка производительности при многократном открытии/закрытии
**Приоритет:** Низкий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты

**Шаги:**
1. Открыть меню
2. Закрыть меню кликом справа
3. Повторить шаги 1-2 10 раз подряд

**Ожидаемый результат:**
- Меню открывается и закрывается плавно без задержек
- Нет утечек памяти
- Приложение остается отзывчивым
- Нет ошибок в логах

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-013: Проверка работы на разных размерах экранов
**Приоритет:** Средний  
**Предусловия:**
- Приложение запущено
- Доступны устройства с разными размерами экранов (или эмуляторы)

**Шаги:**
1. Запустить приложение на устройстве с маленьким экраном (< 5 дюймов)
2. Проверить открытие/закрытие меню
3. Запустить приложение на устройстве с большим экраном (> 6 дюймов)
4. Проверить открытие/закрытие меню

**Ожидаемый результат:**
- Меню корректно работает на всех размерах экранов
- Ширина меню всегда 280.dp
- Кликабельная область справа от меню работает корректно на всех размерах

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

### TC-014: Проверка работы при повороте экрана
**Приоритет:** Низкий  
**Предусловия:**
- Приложение запущено
- Пользователь находится на экране карты
- Меню открыто

**Шаги:**
1. Открыть меню через кнопку бургера
2. Повернуть устройство (портрет -> ландшафт или наоборот)
3. Проверить состояние меню
4. Попытаться закрыть меню кликом справа

**Ожидаемый результат:**
- Меню корректно обрабатывает поворот экрана
- После поворота меню остается в правильном состоянии (открыто/закрыто)
- Кликабельная область работает корректно после поворота

**Фактический результат:**  
**Статус:** [ ] Pass / [ ] Fail  
**Комментарии:**

---

## Чек-лист для быстрой проверки

- [ ] Меню открывается через кнопку бургера
- [ ] Меню закрывается при клике справа от меню
- [ ] Меню закрывается при клике на пункты меню
- [ ] Меню закрывается при повторном клике на кнопку бургера
- [ ] Кликабельная область прозрачна (нет визуального слоя)
- [ ] Карта не интерактивна когда меню открыто
- [ ] Нет ошибок в логах
- [ ] Работает на разных размерах экранов

---

## Известные ограничения

1. **Свайп для открытия меню отключен** - меню можно открыть только через кнопку бургера (это сделано намеренно, чтобы не мешать жестам карты)

2. **Карта не интерактивна когда меню открыто** - это сделано для предотвращения случайных действий на карте при открытом меню

3. **Кликабельная область начинается строго с 280.dp** - это соответствует ширине меню

---

## Примечания для тестировщиков

- При тестировании обращайте внимание на логи в Logcat - они помогут понять, доходят ли события до обработчика
- Если меню не закрывается, проверьте логи на наличие сообщений "DEBUG: Overlay tap detected"
- Если в логах нет наших сообщений, значит события не доходят до обработчика (проблема с z-order или перехватом событий)
- Если сообщения есть, но меню не закрывается, проблема может быть в `drawerState.close()`

---

## Другие проблемы и решения, реализованные в проекте

### Проблема 1: KAPT с Java 17
**Статус:** ✅ **РЕШЕНО**

**Проблема:**
- Ошибки компиляции при использовании KAPT (Kotlin Annotation Processing Tool) с Java 17
- Gradle daemon не применял настройки из `gradle.properties`

**Решение:**
- Добавлены настройки `--add-opens` в `gradle.properties` и `app/build.gradle.kts`
- Временное решение: использование Java 11 для компиляции
- Полное решение: очистка кэшей Gradle и перезапуск daemon

**Файлы:**
- `app/build.gradle.kts` - блок `kapt { javacOptions { ... } }`
- `gradle.properties` - аргументы `--add-opens`

**Тесткейсы:**
- TC-KAPT-001: Проверка компиляции проекта с Java 17
- TC-KAPT-002: Проверка компиляции проекта с Java 11 (временное решение)

---

### Проблема 2: Yandex MapKit и 16 KB страницы
**Статус:** ✅ **РЕШЕНО (временное решение)**

**Проблема:**
- Yandex MapKit версии 4.5.1 не поддерживает 16 KB страницы памяти
- Современные Android устройства требуют поддержку 16 KB страниц

**Решение:**
- Использован legacy packaging для обхода проблемы
- В `app/build.gradle.kts` добавлено: `jniLibs { useLegacyPackaging = true }`
- TODO: Обновить до версии Yandex MapKit с поддержкой 16 KB когда будет доступна

**Файлы:**
- `app/build.gradle.kts` - блок `packaging { jniLibs { useLegacyPackaging = true } }`

**Тесткейсы:**
- TC-MAPKIT-001: Проверка работы карты на устройствах с 16 KB страницами
- TC-MAPKIT-002: Проверка работы карты на устройствах с 4 KB страницами

---

### Проблема 3: Метод hasRoutes() в RouteDataLoader
**Статус:** ✅ **ИСПРАВЛЕНО**

**Проблема:**
- Метод `hasRoutes()` использовал `first()`, который мог выбросить `NoSuchElementException`, если Flow пустой
- Это приводило к крашам при первом запуске приложения

**Решение:**
- Добавлена обработка исключений `NoSuchElementException` и общих `Exception`
- Метод теперь возвращает `false` при пустом Flow или ошибке

**Код:**
```kotlin
suspend fun hasRoutes(): Boolean {
    return try {
        routeDao.getAllRoutes().first().isNotEmpty()
    } catch (e: NoSuchElementException) {
        false
    } catch (e: Exception) {
        android.util.Log.e("RouteDataLoader", "Ошибка проверки наличия маршрутов", e)
        false
    }
}
```

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/data/local/RouteDataLoader.kt`

**Тесткейсы:**
- TC-DATALOADER-001: Проверка работы hasRoutes() при пустой базе данных
- TC-DATALOADER-002: Проверка работы hasRoutes() при наличии данных
- TC-DATALOADER-003: Проверка обработки ошибок в hasRoutes()

---

### Проблема 4: Обработка ошибок парсинга JSON
**Статус:** ✅ **ОБРАБОТАНО**

**Проблема:**
- При парсинге JSON файлов маршрутов могли возникать ошибки
- Ошибки не обрабатывались должным образом

**Решение:**
- Добавлена обработка ошибок в методах `parseRouteData()` и `saveRouteData()`
- Ошибки логируются, но не приводят к крашу приложения

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/data/local/RouteDataLoader.kt`

**Тесткейсы:**
- TC-JSON-001: Проверка обработки невалидного JSON файла
- TC-JSON-002: Проверка обработки отсутствующего JSON файла
- TC-JSON-003: Проверка обработки JSON с неполными данными

---

### Проблема 5: Обработка ошибок в YandexMapView
**Статус:** ✅ **ОБРАБОТАНО**

**Проблема:**
- Ошибки при добавлении/удалении listeners карты не обрабатывались
- Ошибки при добавлении маркеров на карту могли привести к крашу

**Решение:**
- Добавлены try-catch блоки для всех операций с картой
- Ошибки логируются, но не прерывают работу приложения

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/ui/components/YandexMapView.kt`

**Тесткейсы:**
- TC-MAPVIEW-001: Проверка обработки ошибок при добавлении listeners
- TC-MAPVIEW-002: Проверка обработки ошибок при добавлении маркеров
- TC-MAPVIEW-003: Проверка работы карты при отсутствии разрешений

---

### Проблема 6: Обработка ошибок в AudioPlayer
**Статус:** ✅ **ОБРАБОТАНО**

**Проблема:**
- Ошибки воспроизведения аудио не обрабатывались должным образом
- Ошибки могли привести к крашу приложения

**Решение:**
- Добавлена обработка ошибок в методе `play()`
- Добавлен listener для обработки ошибок воспроизведения
- Ошибки логируются с детальной информацией

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/util/AudioPlayer.kt`

**Тесткейсы:**
- TC-AUDIO-001: Проверка обработки ошибок при воспроизведении несуществующего файла
- TC-AUDIO-002: Проверка обработки ошибок при воспроизведении поврежденного файла
- TC-AUDIO-003: Проверка обработки ошибок при отсутствии разрешений

---

### Проблема 7: Обработка ошибок геолокации
**Статус:** ⚠️ **ЧАСТИЧНО ОБРАБОТАНО**

**Проблема:**
- Ошибки получения геолокации могут возникать при отсутствии разрешений или отключенном GPS
- Ошибки не всегда обрабатываются корректно

**Решение:**
- Добавлена базовая обработка ошибок в `MapViewModel` и `LocationManager`
- Рекомендуется добавить runtime permissions для запроса разрешений

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/ui/viewmodel/MapViewModel.kt`
- `app/src/main/java/com/trusttheroute/app/util/LocationManager.kt`

**Тесткейсы:**
- TC-LOCATION-001: Проверка работы геолокации при отсутствии разрешений
- TC-LOCATION-002: Проверка работы геолокации при отключенном GPS
- TC-LOCATION-003: Проверка работы геолокации на эмуляторе

---

### Проблема 8: API endpoints не подключены
**Статус:** ⚠️ **ИЗВЕСТНОЕ ОГРАНИЧЕНИЕ**

**Проблема:**
- Интерфейсы API созданы, но реальные URL endpoints не указаны
- Приложение работает только с данными из assets

**Решение:**
- Приложение использует fallback на данные из assets при недоступности API
- Реализовано в `RouteRepository` - проверка доступности API и использование локальных данных

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/data/repository/RouteRepository.kt`
- `app/src/main/java/com/trusttheroute/app/data/api/RouteApi.kt`

**Тесткейсы:**
- TC-API-001: Проверка работы приложения без подключения к API
- TC-API-002: Проверка работы приложения с подключением к API (когда будет доступно)
- TC-API-003: Проверка синхронизации данных с API

---

### Проблема 9: Аутентификация не реализована
**Статус:** ⚠️ **ИЗВЕСТНОЕ ОГРАНИЧЕНИЕ**

**Проблема:**
- Экраны аутентификации (Login, Register, ResetPassword) являются только заглушками
- Yandex IAM не интегрирован

**Решение:**
- Созданы базовые UI экраны
- Реализация интеграции с Yandex IAM отложена на будущее

**Файлы:**
- `app/src/main/java/com/trusttheroute/app/ui/screens/auth/LoginScreen.kt`
- `app/src/main/java/com/trusttheroute/app/ui/screens/auth/RegisterScreen.kt`
- `app/src/main/java/com/trusttheroute/app/ui/screens/auth/ResetPasswordScreen.kt`

**Тесткейсы:**
- TC-AUTH-001: Проверка отображения экранов аутентификации (UI только)
- TC-AUTH-002: Проверка валидации форм (когда будет реализовано)
- TC-AUTH-003: Проверка интеграции с Yandex IAM (когда будет реализовано)

---

## Общие рекомендации по тестированию

### Проверка обработки ошибок
При тестировании обращайте внимание на:
- Логи в Logcat - все ошибки должны логироваться, но не приводить к крашу
- Поведение приложения при отсутствии интернета
- Поведение при отсутствии разрешений
- Поведение при поврежденных данных

### Проверка производительности
- Откройте приложение и проверьте время загрузки
- Проверьте использование памяти (через Android Studio Profiler)
- Проверьте работу приложения при низком заряде батареи

### Проверка совместимости
- Тестируйте на разных версиях Android (минимум API 26)
- Тестируйте на разных размерах экранов
- Тестируйте в портретной и ландшафтной ориентации

---

## Связанные документы

- `DRAWER_IMPLEMENTATION.md` - детальное описание реализации drawer меню
- `TESTING_REPORT.md` - отчет о тестировании приложения
- `АНАЛИЗ_ПРОЕКТА.md` - общий анализ проекта и известные проблемы
- `DEBUG_LOGCAT_ERRORS.md` - инструкции по отладке ошибок в Logcat
- `KAPT_URGENT_FIX.md` - решение проблемы с KAPT и Java 17
