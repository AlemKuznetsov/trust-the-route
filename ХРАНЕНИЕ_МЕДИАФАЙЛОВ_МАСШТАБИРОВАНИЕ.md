# Хранение медиафайлов при масштабировании (100+ маршрутов, 500+ достопримечательностей)

## 📊 Проблема масштабирования

### Текущая ситуация:
- ✅ 1 маршрут ("Автобус Б")
- ✅ 18 достопримечательностей
- ✅ 64 фотографии (~5-10 MB)
- ✅ 18 аудиофайлов (~50-100 MB)
- ✅ **Общий размер:** ~60-110 MB

### При масштабировании:
- ⚠️ 100 маршрутов
- ⚠️ 500+ достопримечательностей
- ⚠️ 2000+ фотографий (~200-400 MB)
- ⚠️ 500+ аудиофайлов (~2-5 GB)
- ⚠️ **Общий размер:** ~2.5-5.5 GB

---

## ❌ Почему текущее решение (assets) НЕ подходит

### Проблемы с assets:

1. **Размер APK:**
   - Google Play ограничивает размер APK до 100 MB
   - Расширенные файлы (AAB) до 150 MB
   - **2.5-5.5 GB не поместятся!**

2. **Обновления:**
   - Каждое обновление = полная переустановка
   - Пользователь должен скачивать все файлы заново
   - **Очень медленно и неудобно**

3. **Использование памяти:**
   - Все файлы в памяти при установке
   - Занимают место на устройстве
   - **Проблема для устройств с малым объемом памяти**

---

## ✅ Решения для масштабирования

### Вариант 1: Облачное хранилище + кэширование ⭐ РЕКОМЕНДУЮ

**Архитектура:**
```
Сервер/CDN → Загрузка по требованию → Локальное кэширование → Использование
```

**Как работает:**
1. Медиафайлы хранятся на сервере/CDN
2. Приложение загружает файлы по мере необходимости
3. Файлы кэшируются локально на устройстве
4. При повторном использовании берутся из кэша

**Преимущества:**
- ✅ Не увеличивает размер APK
- ✅ Загрузка только нужных файлов
- ✅ Обновления без переустановки приложения
- ✅ Экономия места на устройстве
- ✅ Быстрая загрузка через CDN

**Недостатки:**
- ⚠️ Требует интернет для первой загрузки
- ⚠️ Нужен сервер/CDN

**Стоимость:**
- Yandex Object Storage: ~1-2₽/GB/месяц
- Для 5 GB: ~5-10₽/месяц
- Очень доступно!

---

### Вариант 2: Гибридный подход ⭐ ОПТИМАЛЬНЫЙ

**Архитектура:**
```
Базовые данные (assets) → Дополнительные данные (сервер) → Кэш
```

**Как работает:**
1. **Базовые данные** (1-2 маршрута) в assets для оффлайн работы
2. **Остальные маршруты** загружаются с сервера по требованию
3. **Медиафайлы** загружаются с CDN и кэшируются локально
4. **Умное кэширование:** часто используемые файлы остаются, редко используемые удаляются

**Преимущества:**
- ✅ Работает оффлайн (базовые маршруты)
- ✅ Масштабируемость (неограниченное количество маршрутов)
- ✅ Экономия места (загрузка только нужного)
- ✅ Быстрые обновления

**Недостатки:**
- ⚠️ Требует сервер/CDN
- ⚠️ Нужна логика кэширования

---

### Вариант 3: Локальное хранилище (не рекомендуется)

**Архитектура:**
```
Сервер → Загрузка всех файлов → Локальное хранилище → Использование
```

**Проблемы:**
- ❌ Занимает много места (2.5-5.5 GB)
- ❌ Первая загрузка очень долгая
- ❌ Проблемы на устройствах с малым объемом памяти
- ❌ Сложно обновлять

**Когда использовать:**
- Только если нужна полная оффлайн работа
- И пользователь готов ждать загрузку

---

## 🏗️ Рекомендуемая архитектура

### Структура хранения:

```
┌─────────────────────────────────────────┐
│         Облачное хранилище (CDN)        │
│  ┌───────────────────────────────────┐ │
│  │  Yandex Object Storage / S3        │ │
│  │  - Фотографии (2000+ файлов)       │ │
│  │  - Аудиофайлы (500+ файлов)       │ │
│  │  - Метаданные маршрутов (JSON)    │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Бэкенд API (VPS)                │
│  ┌───────────────────────────────────┐ │
│  │  Kotlin + Ktor                     │ │
│  │  - Список маршрутов               │ │
│  │  - Метаданные достопримечательностей│ │
│  │  - Ссылки на медиафайлы           │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Android приложение                 │
│  ┌───────────────────────────────────┐ │
│  │  Локальное кэширование            │ │
│  │  - Часто используемые файлы      │ │
│  │  - Текущий маршрут               │ │
│  │  - Room база данных (метаданные) │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 💾 Где хранить медиафайлы

### 1. Yandex Object Storage ⭐ РЕКОМЕНДУЮ (для России)

**Почему подходит:**
- ✅ Российский сервис (быстрая скорость в России)
- ✅ Очень дешево (~1-2₽/GB/месяц)
- ✅ Интеграция с Yandex Cloud
- ✅ CDN встроен
- ✅ Простая настройка

**Стоимость:**
- Хранение: ~1-2₽/GB/месяц
- Трафик: ~0.5-1₽/GB
- Для 5 GB: ~5-10₽/месяц + трафик

**Документация:** https://cloud.yandex.ru/docs/storage/

---

### 2. Amazon S3 + CloudFront

**Почему подходит:**
- ✅ Очень надежный
- ✅ Отличный CDN (CloudFront)
- ✅ Хорошая производительность

**Стоимость:**
- Хранение: ~$0.023/GB/месяц (~2₽/GB)
- Трафик: ~$0.09/GB (~9₽/GB)
- Для 5 GB: ~$0.12/месяц (~12₽) + трафик

---

### 3. Google Cloud Storage

**Почему подходит:**
- ✅ Хорошая интеграция с Firebase
- ✅ Надежность
- ✅ CDN встроен

**Стоимость:**
- Хранение: ~$0.020/GB/месяц (~2₽/GB)
- Трафик: ~$0.12/GB (~12₽/GB)

---

### 4. Firebase Storage

**Почему подходит:**
- ✅ Простая интеграция
- ✅ Бесплатный план (5 GB)
- ✅ Хорошая документация

**Стоимость:**
- Бесплатно: 5 GB хранения, 1 GB трафика/день
- Платно: ~$0.026/GB/месяц

---

## 🔧 Реализация в приложении

### 1. Структура данных

**Метаданные в Room (локально):**
```kotlin
@Entity
data class RouteEntity(
    @PrimaryKey val id: String,
    val name: String,
    val description: String,
    val polyline: String,
    // Ссылки на медиафайлы в облаке
    val coverImageUrl: String? = null
)

@Entity
data class AttractionEntity(
    @PrimaryKey val id: String,
    val routeId: String,
    val name: String,
    val description: String,
    val latitude: Double,
    val longitude: Double,
    // Ссылки на медиафайлы в облаке
    val imageUrls: List<String>, // JSON массив URL
    val audioUrl: String? = null
)
```

**Медиафайлы в облаке:**
- Фотографии: `https://storage.yandexcloud.net/bucket/images/attraction_1.jpg`
- Аудио: `https://storage.yandexcloud.net/bucket/audio/attraction_1.mp3`

---

### 2. Загрузка и кэширование

**Использовать библиотеки:**
- **Coil** (уже используется) - для изображений с кэшированием
- **ExoPlayer** (уже используется) - для аудио с кэшированием
- **OkHttp Cache** - для HTTP кэширования

**Пример кода:**

```kotlin
// Загрузка изображения с кэшированием
AsyncImage(
    model = ImageRequest.Builder(context)
        .data(attraction.imageUrls.first())
        .diskCacheKey(attraction.id) // Кэш по ID
        .memoryCacheKey(attraction.id)
        .build(),
    contentDescription = attraction.name
)

// Загрузка аудио с кэшированием
audioPlayer.play(
    url = attraction.audioUrl,
    cacheEnabled = true // Кэшировать локально
)
```

---

### 3. Умное кэширование

**Стратегия:**
1. **Автоматически кэшировать:**
   - Текущий маршрут (все медиафайлы)
   - Часто используемые маршруты
   - Недавно просмотренные достопримечательности

2. **Удалять из кэша:**
   - Старые неиспользуемые файлы
   - При нехватке места
   - По истечении срока (например, 30 дней)

3. **Ограничения:**
   - Максимальный размер кэша: 500 MB - 1 GB
   - При превышении удалять самые старые файлы

---

## 📊 Сравнение вариантов

| Критерий | Assets | Облако + кэш | Локальное хранилище |
|----------|--------|--------------|---------------------|
| **Размер APK** | ❌ Огромный | ✅ Маленький | ✅ Маленький |
| **Первая загрузка** | ✅ Быстро | ⚠️ Зависит от интернета | ❌ Очень долго |
| **Обновления** | ❌ Переустановка | ✅ Быстро | ⚠️ Загрузка |
| **Место на устройстве** | ❌ Все файлы | ✅ Только кэш | ❌ Все файлы |
| **Оффлайн работа** | ✅ Полная | ⚠️ Частичная | ✅ Полная |
| **Масштабируемость** | ❌ Нет | ✅ Да | ⚠️ Ограничена |

---

## 💰 Стоимость хранения

### Для 5 GB медиафайлов:

**Yandex Object Storage:**
- Хранение: 5 GB × 1.5₽ = 7.5₽/месяц
- Трафик: ~1000 пользователей × 50 MB = 50 GB × 0.5₽ = 25₽/месяц
- **Итого: ~30-50₽/месяц**

**Amazon S3:**
- Хранение: 5 GB × $0.023 = $0.12/месяц (~12₽)
- Трафик: 50 GB × $0.09 = $4.5/месяц (~450₽)
- **Итого: ~450-500₽/месяц**

**Firebase Storage:**
- Бесплатно: до 5 GB хранения
- Платно: ~$0.13/месяц (~13₽) + трафик

---

## 🎯 Рекомендация

### Для вашего проекта:

**Использовать: Yandex Object Storage + локальное кэширование**

**Почему:**
1. ✅ Очень дешево (~30-50₽/месяц)
2. ✅ Быстрая скорость в России
3. ✅ Интеграция с Yandex Cloud
4. ✅ Масштабируемость
5. ✅ Не увеличивает размер APK

**Архитектура:**
```
Yandex Object Storage (медиафайлы)
    ↓
Бэкенд API (VPS) (метаданные)
    ↓
Android приложение (кэш часто используемых файлов)
```

---

## 📋 План реализации

### Этап 1: Настройка облачного хранилища
1. Создать bucket в Yandex Object Storage
2. Загрузить медиафайлы
3. Настроить публичный доступ (или через подписанные URL)

### Этап 2: Обновить структуру данных
1. Добавить поля `imageUrls` и `audioUrl` в модели
2. Обновить Room базу данных
3. Обновить загрузчик данных

### Этап 3: Реализовать загрузку
1. Использовать Coil для изображений (уже есть)
2. Настроить кэширование в ExoPlayer
3. Добавить логику умного кэширования

### Этап 4: Оптимизация
1. Ленивая загрузка (только видимые элементы)
2. Предзагрузка следующего маршрута
3. Очистка неиспользуемых файлов

---

## ✅ Итог

**Для масштабирования до 100+ маршрутов и 500+ достопримечательностей:**

1. ✅ **Медиафайлы** → Yandex Object Storage (облако)
2. ✅ **Метаданные** → Бэкенд API (VPS)
3. ✅ **Кэш** → Локальное хранилище (умное кэширование)
4. ✅ **Базовые данные** → Assets (1-2 маршрута для оффлайн)

**Стоимость:** ~30-50₽/месяц для хранения + трафик

**Результат:** Масштабируемое решение без увеличения размера APK!
